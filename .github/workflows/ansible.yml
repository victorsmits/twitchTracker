name: Ansible deploy

on: workflow_dispatch
jobs:
  ansible:
    runs-on: self-hosted
    steps:
      - name: checkout repo
        uses: actions/checkout@v3
      - name: setup .env file
        uses: victorsmits/secrets-to-env-file@1.0.2
        id: secrets_env
        with:
          secrets: ${{ toJSON(secrets) }}
          convert: lower
          exclude: DOCKER_*, ANSIBLE_*, MINIO_*, SSH_*
      - run: echo ${{join(steps.secrets_env.outputs.*, '\n')}} > .env
      - name: copy .env to deploy folder
        run: cp .env ~/deployment/twitchtracker/.env
      - name: Run playbook
        uses: dawidd6/action-ansible-playbook@v2
        env:
          REGISTRY_URL: registry.victorsmits.com
          REGISTRY_USER: ${{ secrets.DOCKER_USERNAME }}
          REGISTRY_PASS: ${{ secrets.DOCKER_PASSWORD }}
        with:
          playbook: .ansible/deploy.yml
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          requirements: .ansible/requirement.yml
          options: |
            --inventory .ansible/production
            --user agent
            --extra-vars "ansible_sudo_pass=${{ secrets.ANSIBLE_SUDO_PASSWORD }}"
            --verbose
          verbose: 4
